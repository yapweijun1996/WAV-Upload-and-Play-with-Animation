
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Enhanced Winter Audio Visualizer</title>
    <style>
        body {
            margin: 0;
            background: linear-gradient(to bottom, #001f3f, #001a33);
            overflow: hidden;
            font-family: 'Roboto', sans-serif;
            color: #fff;
        }
        #controlPanel {
            position: absolute;
            top: 20px;
            right: 20px;
            text-align: left;
            z-index: 1;
            background: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 8px;
            width: 280px;
        }
        #controlPanel h1 {
            font-size: 20px;
            margin-bottom: 10px;
            color: #00d1b2;
        }
        #controlPanel label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        #controlPanel input[type="file"] {
            margin-bottom: 15px;
            width: 100%;
        }
        #controlPanel select, #controlPanel button {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            font-size: 16px;
            border: none;
            border-radius: 4px;
        }
        #controlPanel select {
            background-color: #005f73;
            color: #fff;
        }
        #controlPanel button {
            background-color: #00a896;
            color: #fff;
            cursor: pointer;
        }
        #controlPanel button:disabled {
            background-color: #00494d;
            cursor: not-allowed;
        }
        #controlPanel #progressBar {
            width: 100%;
            background-color: #00494d;
            border-radius: 4px;
            overflow: hidden;
            height: 20px;
            margin-bottom: 10px;
            display: none;
        }
        #controlPanel #progressBar div {
            height: 100%;
            width: 0%;
            background-color: #00d1b2;
            text-align: center;
            line-height: 20px;
            color: #fff;
            font-size: 14px;
        }
        #controlPanel #status {
            font-size: 14px;
            margin-bottom: 10px;
        }
        #controlPanel #downloadLink {
            display: none;
            margin-top: 10px;
            color: #00d1b2;
            text-decoration: none;
            font-size: 16px;
            text-align: center;
        }
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
        }
        /* Tooltip styling */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 180px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 2;
            bottom: 125%;
            left: 50%;
            margin-left: -90px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        /* Responsive adjustments */
        @media screen and (max-width: 768px) {
            #controlPanel {
                width: 90%;
                right: 5%;
                top: 10px;
            }
        }
    </style>
    <!-- Import Font -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
    <!-- Import Icons -->
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>
<body>
    <div id="controlPanel">
        <h1><i class="fas fa-snowflake"></i> Winter Audio Visualizer</h1>
        <label for="upload" class="tooltip">Select Audio File
            <span class="tooltiptext">Supported formats: WAV, MP3</span>
        </label>
        <input type="file" id="upload" accept=".wav, .mp3">
        <label for="animationType">Choose Animation</label>
        <select id="animationType">
            <option value="snowstorm">Dynamic Snowstorm</option>
            <option value="aurora">Aurora Borealis</option>
            <option value="winterForest">Winter Forest</option>
        </select>
        <button id="startRecording" disabled><i class="fas fa-play"></i> Start Recording</button>
        <button id="stopRecording" disabled style="display: none;"><i class="fas fa-stop"></i> Stop Recording</button>
        <div id="progressBar">
            <div id="progressBarFill">0%</div>
        </div>
        <div id="status"></div>
        <a id="downloadLink" href="#" download="animation.webm" style="display: none;"><i class="fas fa-download"></i> Download Video</a>
    </div>
    <audio id="audio" controls style="display: none;"></audio>
    <canvas id="canvas" width="1920" height="1080"></canvas>
    <script>
        const upload = document.getElementById('upload');
        const animationTypeSelect = document.getElementById('animationType');
        const audio = document.getElementById('audio');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const startRecordingBtn = document.getElementById('startRecording');
        const stopRecordingBtn = document.getElementById('stopRecording');
        const downloadLink = document.getElementById('downloadLink');
        const status = document.getElementById('status');
        const progressBar = document.getElementById('progressBar');
        const progressBarFill = document.getElementById('progressBarFill');

        let audioContext, analyser, dataArray, bufferLength;
        let mediaRecorder, chunks = [];
        let WIDTH = canvas.width;
        let HEIGHT = canvas.height;
        let animationId;
        let animationType = 'snowstorm';

        const config = {
            backgroundColor: '#001f3f',
            fftSize: 1024,
            smoothingTimeConstant: 0.8,
        };

        upload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file && (file.type === 'audio/wav' || file.type === 'audio/mp3')) {
                status.textContent = '';
                startRecordingBtn.disabled = false;
                const url = URL.createObjectURL(file);
                audio.src = url;
                audio.load();
                if (audioContext) {
                    audioContext.close();
                }
                setupAudioContext();
            } else {
                status.textContent = 'Please upload an audio file (WAV or MP3).';
            }
        });

        animationTypeSelect.addEventListener('change', function() {
            animationType = this.value;
            initAnimations();
        });

        startRecordingBtn.addEventListener('click', function() {
            startRecording();
            audio.play();
            startRecordingBtn.disabled = true;
            stopRecordingBtn.disabled = true;
        });

        function setupAudioContext() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const source = audioContext.createMediaElementSource(audio);
            analyser = audioContext.createAnalyser();
            analyser.fftSize = config.fftSize;
            analyser.smoothingTimeConstant = config.smoothingTimeConstant;
            source.connect(analyser);
            analyser.connect(audioContext.destination);
            bufferLength = analyser.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength);
            initAnimations();
            draw();
        }

        // Variables for the new animations
        let snowflakes = [];
        let auroraParticles = [];
        let trees = [];

        function initAnimations() {
            snowflakes = [];
            auroraParticles = [];
            trees = [];
            if (animationType === 'snowstorm') {
                // Initialize snowflakes
                for (let i = 0; i < 300; i++) {
                    snowflakes.push(createSnowflake());
                }
            } else if (animationType === 'aurora') {
                // Initialize aurora particles
                for (let i = 0; i < 100; i++) {
                    auroraParticles.push(createAuroraParticle());
                }
            } else if (animationType === 'winterForest') {
                // Initialize forest
                for (let i = 0; i < 50; i++) {
                    trees.push(createTree());
                }
                for (let i = 0; i < 200; i++) {
                    snowflakes.push(createSnowflake());
                }
            }
        }

        function draw() {
            animationId = requestAnimationFrame(draw);
            analyser.getByteFrequencyData(dataArray);

            ctx.clearRect(0, 0, WIDTH, HEIGHT);
            ctx.fillStyle = config.backgroundColor;
            ctx.fillRect(0, 0, WIDTH, HEIGHT);

            switch (animationType) {
                case 'snowstorm':
                    drawSnowstorm();
                    break;
                case 'aurora':
                    drawAurora();
                    break;
                case 'winterForest':
                    drawWinterForest();
                    break;
            }
        }

        function createSnowflake() {
            return {
                x: Math.random() * WIDTH,
                y: Math.random() * HEIGHT,
                radius: Math.random() * 3 + 1,
                speed: Math.random() * 1 + 0.5,
                wind: Math.random() * 1 - 0.5,
                angle: Math.random() * Math.PI * 2
            };
        }

        function drawSnowstorm() {
            let avgFrequency = dataArray.reduce((a, b) => a + b) / bufferLength;

            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            for (let flake of snowflakes) {
                ctx.save();
                ctx.translate(flake.x, flake.y);
                ctx.rotate(flake.angle);
                ctx.beginPath();
                ctx.arc(0, 0, flake.radius + avgFrequency / 100, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();

                flake.y += flake.speed + avgFrequency / 50;
                flake.x += flake.wind + avgFrequency / 200;
                flake.angle += 0.01;

                if (flake.y > HEIGHT) {
                    flake.y = -flake.radius;
                    flake.x = Math.random() * WIDTH;
                }
                if (flake.x > WIDTH) {
                    flake.x = 0;
                } else if (flake.x < 0) {
                    flake.x = WIDTH;
                }
            }
        }

        function createAuroraParticle() {
            return {
                x: Math.random() * WIDTH,
                y: Math.random() * HEIGHT / 2,
                speedY: Math.random() * 0.5 + 0.2,
                color: `hsla(${Math.random() * 40 + 120}, 100%, 70%, 0.5)`
            };
        }

        function drawAurora() {
            let avgFrequency = dataArray.reduce((a, b) => a + b) / bufferLength;
            ctx.save();
            ctx.globalCompositeOperation = 'lighter';
            for (let particle of auroraParticles) {
                ctx.fillStyle = particle.color;
                ctx.beginPath();
                ctx.arc(particle.x, particle.y, avgFrequency / 30 + 5, 0, Math.PI * 2);
                ctx.fill();

                particle.y -= particle.speedY + avgFrequency / 100;
                if (particle.y < 0) {
                    particle.y = HEIGHT / 2 + Math.random() * HEIGHT / 2;
                    particle.x = Math.random() * WIDTH;
                }
            }
            ctx.restore();
        }

        function createTree() {
            return {
                x: Math.random() * WIDTH,
                height: Math.random() * 100 + 50,
                color: 'rgba(34, 139, 34, 1)'
            };
        }

        function drawWinterForest() {
            // Draw the trees
            ctx.fillStyle = '#004d00';
            for (let tree of trees) {
                ctx.beginPath();
                ctx.moveTo(tree.x, HEIGHT);
                ctx.lineTo(tree.x - tree.height / 2, HEIGHT - tree.height);
                ctx.lineTo(tree.x + tree.height / 2, HEIGHT - tree.height);
                ctx.closePath();
                ctx.fill();
            }

            // Snowflakes that react to audio
            let avgFrequency = dataArray.reduce((a, b) => a + b) / bufferLength;
            ctx.fillStyle = 'white';
            for (let flake of snowflakes) {
                ctx.beginPath();
                ctx.arc(flake.x, flake.y, flake.radius + avgFrequency / 200, 0, Math.PI * 2);
                ctx.fill();

                flake.y += flake.speed + avgFrequency / 100;
                flake.x += flake.wind;

                if (flake.y > HEIGHT) {
                    flake.y = -flake.radius;
                    flake.x = Math.random() * WIDTH;
                }
                if (flake.x > WIDTH) {
                    flake.x = 0;
                } else if (flake.x < 0) {
                    flake.x = WIDTH;
                }
            }
        }

        function startRecording() {
            chunks = [];
            const canvasStream = canvas.captureStream(30); // 30 FPS
            const audioStream = audio.captureStream();

            const combinedStream = new MediaStream([...canvasStream.getVideoTracks(), ...audioStream.getAudioTracks()]);
            mediaRecorder = new MediaRecorder(combinedStream, { mimeType: 'video/webm; codecs=vp9' });

            mediaRecorder.ondataavailable = function(event) {
                if (event.data.size > 0) {
                    chunks.push(event.data);
                }
            };

            mediaRecorder.onstop = function() {
                const blob = new Blob(chunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'animation.webm';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                status.textContent = 'Recording completed.';
                progressBar.style.display = 'none';
            };

            mediaRecorder.onstart = function() {
                progressBar.style.display = 'block';
                updateProgressBar();
            };

            mediaRecorder.start();
            audio.currentTime = 0;
            audio.play();
            status.textContent = 'Recording...';

            startRecordingBtn.disabled = true;
            stopRecordingBtn.disabled = true;
            upload.disabled = true;
            animationTypeSelect.disabled = true;
        }

        function stopRecording() {
            mediaRecorder.stop();
            audio.pause();
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            status.textContent = 'Processing video...';

            startRecordingBtn.disabled = false;
            stopRecordingBtn.disabled = true;
            upload.disabled = false;
            animationTypeSelect.disabled = false;
        }

        function updateProgressBar() {
            const duration = audio.duration;
            if (duration > 0 && !audio.paused) {
                const currentTime = audio.currentTime;
                const progress = (currentTime / duration) * 100;
                progressBarFill.style.width = progress + '%';
                progressBarFill.textContent = Math.floor(progress) + '%';
                requestAnimationFrame(updateProgressBar);
            }
        }

        audio.addEventListener('ended', function() {
            stopRecording();
        });
    </script>
</body>
</html>